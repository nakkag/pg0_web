<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script type="text/javascript" src="script_common_debug.js"></script>
	<!-- script type="text/javascript" src="../engine/script_common.js"></script -->
	<script type="text/javascript" src="../engine/script_parse.js"></script>
	<script type="text/javascript" src="../engine/script_exec.js"></script>
	<style type="text/css">
	.error {color: red;}
	</style>
	<script type="text/javascript">
	function escapeHTML(str) {
		return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
	}
	ScriptExec.lib['error'] = async function(ei, param, ret) {
		if (param.length === 0) {
			return -2;
		}
		let str = '';
		if (param[0].v.type === TYPE_ARRAY) {
			str = '{' + arrayToString(param[0].v.array) + '}'
		} else {
			str = ScriptExec.getValueString(param[0].v);
		}
		document.getElementById('result').innerHTML += '<p class="error">' + escapeHTML(str) + '</p>';
		return 0;
	};
	ScriptExec.lib['print'] = async function(ei, param, ret) {
		if (param.length === 0) {
			return -2;
		}
		let str = '';
		if (param[0].v.type === TYPE_ARRAY) {
			str = '{' + arrayToString(param[0].v.array) + '}'
		} else {
			str = ScriptExec.getValueString(param[0].v);
		}
		document.getElementById('result').innerHTML += escapeHTML(str).replace(/\\n/, '<br />');
		return 0;
	};
	function arrayToString(array) {
		let ret = '';
		array.forEach(function(a) {
			if (ret) {
				ret = ret + ', ';
			}
			if (a.name) {
				ret += '"' + a.name + '": ';
			}
			if (a.v.type === TYPE_ARRAY) {
				ret += '{' + arrayToString(a.v.array) + '}';
			} else if (a.v.type === TYPE_STRING) {
				ret += '"' + a.v.str + '"';
			} else {
				ret += a.v.num;
			}
		});
		return ret;
	}
	let run = false;
	async function exec() {
		if (document.getElementById("exec_button").value === 'Stop') {
			run = false;
			return;
		}
		run = true;
		document.getElementById("exec_button").value = 'Stop';
		const elm = document.getElementsByClassName('lib');
		if (0 < elm.length) {
			Array.from(elm).forEach(function(v) {
				return v.remove();
			});
		}
		const buf = document.getElementById('src').value;
		const sci = Script.initScriptInfo({extension: true});
		scis = [sci];
		await _exec(scis, sci, buf, false);
		document.getElementById('result').innerHTML += '<hr />';
		document.getElementById("exec_button").value = 'Exec';
		run = false;
	}
	async function loadScript(file) {
		return new Promise((resolve, reject) => {
			const script = document.createElement('script');
			script.classList.add('lib');
			script.src = file;
			script.onload = () => resolve(script);
			script.onerror = () => reject(new Error('Script load error'));
			document.head.appendChild(script);
		});
	}
	async function _exec(scis, sci, buf, imp) {
		const sp = new ScriptParse(sci);
		try {
			await sp.parse(buf, {
				import: async function(file) {
					const _buf = document.getElementById(file).value;
					const _sci = Script.initScriptInfo({extension: true});
					scis.push(_sci);
					await _exec(scis, _sci, _buf, true);
				},
				library: async function(file) {
					await loadScript(file);
				},
				success: async function(token) {
					//console.log(token);
					const se = new ScriptExec(scis, sci);
					try {
						let syncCnt = 0;
						await se.exec(token, {}, {
							callback: async function(ei) {
								//console.log('token=' + ei.token[ei.index].type + ', vi=' + JSON.stringify(ei.vi));
								syncCnt++;
								if (syncCnt > 1000) {
									await new Promise(resolve => setTimeout(resolve, 0));
									syncCnt = 0;
								}
								if (!run) {
									return 1;
								}
								return 0;
							},
							success: async function(value) {
								if (imp) {
									return;
								}
								if (value.type === TYPE_INTEGER || value.type === TYPE_FLOAT) {
									document.getElementById('result').innerHTML += '<p>Result: ' + value.num + '</p>';
								} else if (value.type === TYPE_STRING) {
									document.getElementById('result').innerHTML += '<p>Result: ' + escapeHTML(value.str) + '</p>';
								} else if (value.type === TYPE_ARRAY) {
									document.getElementById('result').innerHTML += '<p>Result: {' + escapeHTML(arrayToString(value.array)) + '}</p>';
								}
							},
							error: async function(error) {
								document.getElementById('result').innerHTML += '<p class="error">Exec Error: ' + error.msg + ' (' + (error.line + 1) + ')</p>';
							}
						});
					} catch(e) {
						document.getElementById('result').innerHTML += '<p class="error">Exec Error: ' + e + '</p>';
					}
				},
				error: async function(error) {
					document.getElementById('result').innerHTML += '<p class="error">Parse Error: ' + error.msg + ' (' + (error.line + 1) + ')</p>';
				}
			});
		} catch(e) {
			document.getElementById('result').innerHTML += '<p class="error">Parse Error: ' + e + '</p>';
		}
	}
	function clearResult() {
		document.getElementById('result').innerHTML = '';
	}
	</script>
</head>
<body>

<textarea id="src" style="width:350px;height:200px;">
#import("src2")

a()
</textarea>
<textarea id="src2" style="width:350px;height:200px;">
#library("lib_test.js")
function a() {
debug("aaa")
}
</textarea>
<div><input type="button" id="exec_button" value="Exec" onclick="exec();"></input> <input type="button" value="Clear" onclick="clearResult();"></input></div>
<hr />
<div><span id="result"></span></div>

</body>
</html>

